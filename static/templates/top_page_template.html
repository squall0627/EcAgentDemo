<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECå•†å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <!-- å¤–éƒ¨CSSãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="/static/css/top_page_styles.css">
</head>
<body>
    <!-- å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="history-overlay" id="historyOverlay" onclick="closeHistorySidebar()"></div>

    <!-- å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="history-sidebar" id="historySidebar">
        <div class="history-header">
            <h3 style="margin: 0;">ğŸ“– ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h3>
            <button class="history-close-btn" onclick="closeHistorySidebar()">Ã—</button>
        </div>
        <div class="history-content" id="historyContent">
            <div class="no-history">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ç…§ä¼šãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="table-overlay" id="tableOverlay" onclick="closeTableViewer()"></div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ç…§ä¼šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="table-modal" id="tableModal">
        <div class="table-modal-header">
            <h3 style="margin: 0;">ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«ç…§ä¼š</h3>
            <button class="table-close-btn" onclick="closeTableViewer()">Ã—</button>
        </div>

        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã‚¿ãƒ– -->
        <div class="table-tabs">
            <button class="table-tab active" onclick="switchTable('products')">å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«</button>
            <button class="table-tab" onclick="switchTable('orders')">æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«</button>
            <button class="table-tab" onclick="switchTable('order_items')">æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«</button>
        </div>

        <!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="table-filters" id="tableFilters">
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š -->
        <div class="table-pagination-controls">
            <label>è¡¨ç¤ºä»¶æ•°: 
                <select id="limitSelect" onchange="updateLimit()">
                    <option value="10">10ä»¶</option>
                    <option value="25" selected>25ä»¶</option>
                    <option value="50">50ä»¶</option>
                    <option value="100">100ä»¶</option>
                </select>
            </label>
            <button class="reimport-btn" onclick="confirmReimportData()">ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒ»å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>

        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="table-content" id="tableContent">
            <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="table-pagination" id="tablePagination">
            <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 style="margin: 0; color: #343a40;">ğŸ¤– ECå•†å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                    <p style="margin: 10px 0 0 0; color: #6c757d;">è‡ªç„¶è¨€èªã§AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å¯¾è©±ã—ã¦å•†å“ã‚’ç®¡ç†ã§ãã¾ã™</p>
                </div>
                <div class="header-actions">
                    <button class="settings-btn" onclick="openSettings()" title="ã‚·ã‚¹ãƒ†ãƒ è¨­å®š">
                        âš™ï¸
                    </button>
                </div>
            </div>
        </div>

        <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã¨å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
        <div class="session-info">
            <span>ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: <span id="sessionId"></span></span>
            <div class="session-actions">
                <button class="table-btn" onclick="openTableViewer()">ãƒ†ãƒ¼ãƒ–ãƒ«ç…§ä¼š</button>
                <button class="history-btn" onclick="openHistorySidebar()">å±¥æ­´è¡¨ç¤º</button>
                <button class="new-chat-btn" onclick="startNewChat()">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</button>
            </div>
        </div>

        <!-- ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="chat-container">
            <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆè¨­å®šã‚¨ãƒªã‚¢ï¼‰ -->
            <div class="chat-header">
                <div class="config-grid">
                    <!-- Left column: Agent selection -->
                    <div class="config-column">
                        <div class="config-label">ğŸ§  ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:</div>
                        <select id="agentSelect" class="agent-select">
                            {{AGENT_OPTIONS}}
                        </select>
                    </div>

                    <!-- Center column: LLM selection -->
                    <div class="config-column">
                        <div class="config-label">ğŸ¤– LLM:</div>
                        <select id="llmSelect" class="llm-select">
                            {{LLM_OPTIONS}}
                        </select>
                    </div>

                    <!-- Right column: Selected LLM status and pricing -->
                    <div class="config-column">
                        <div class="llm-status">
                            <span class="llm-indicator" id="llmIndicator"></span>
                            <span id="llmStatus">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                        <div class="llm-pricing" id="llmPricing">
                            <!-- ä¾¡æ ¼æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                </div>

                <div class="examples" id="examplesSection">
                    <div class="examples-header">
                        <strong>ğŸ’¡ ä½¿ç”¨ä¾‹:</strong>
                        <button id="toggleExamplesBtn" class="toggle-examples-btn" title="ä½¿ç”¨ä¾‹ã‚’æŠ˜ã‚ŠãŸãŸã‚€/å±•é–‹ã™ã‚‹">
                            <span class="toggle-icon">â–¼</span>
                        </button>
                    </div>
                    <div class="examples-content" id="examplesContent">
                        <ul>
                            <li>"ã‚³ãƒ¼ãƒ’ãƒ¼å•†å“ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„"</li>
                            <li>"åœ¨åº«ãŒå°‘ãªã„å•†å“ã‚’æ£šä¸Šã’ã—ã¦ãã ã•ã„"</li>
                            <li>"JANã‚³ãƒ¼ãƒ‰123ã®å•†å“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„"</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
            <div id="chatMessages" class="chat-messages">
                <div class="welcome-message">
                    <h4>ğŸ‘‹ ã‚ˆã†ã“ãï¼</h4>
                    <p>ä¸‹ã®å…¥åŠ›æ¬„ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚<br>
                    ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«é©åˆ‡ãªæ“ä½œç”»é¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="chat-input-area">
                <div class="input-container">
                    <!-- å·¦ä¸‹è§’ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
                    <button id="imageBtn" class="plus-button" onclick="triggerImageUpload()" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰">
                        +æ·»ä»˜
                    </button>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">

                    <div class="input-wrapper">
                        <textarea 
                            id="commandInput" 
                            class="chat-input" 
                            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                            maxlength="2000"
                            rows="1"></textarea>
                        <button id="voiceBtn" class="voice-button" onclick="toggleVoiceRecording()" title="éŸ³å£°å…¥åŠ›">
                            ğŸ¤
                        </button>
                        <button id="sendBtn" class="send-button" onclick="sendMessage()" title="é€ä¿¡ (Enter)">
                            â¤
                        </button>
                    </div>
                </div>
                <div class="input-hint">
                    Shift+Enter: æ”¹è¡Œ | Enter: é€ä¿¡ | æœ€å¤§2000æ–‡å­— | æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º10M
                </div>
            </div>
        </div>
    </div>

    <script>
        // LLMè¨­å®šï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
        const llmConfigs = "{{LLM_JS_CONFIG}}";

        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®šï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
        const agentConfigs = "{{AGENT_JS_CONFIG}}";

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯èªè¨¼ã‹ã‚‰å–å¾—ï¼‰
        const currentUserId = 'default_user';

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç®¡ç†
        let currentSessionId = localStorage.getItem('productManagementSessionId');

        // ä¸€æ™‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
        let tempUploadedFiles = [];
        if (!currentSessionId) {
            currentSessionId = generateSessionId();
            localStorage.setItem('productManagementSessionId', currentSessionId);
        }
        document.getElementById('sessionId').textContent = currentSessionId;

        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMé¸æŠã®ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½
        function saveAgentSelection() {
            const agentSelect = document.getElementById('agentSelect');
            localStorage.setItem('selectedAgent', agentSelect.value);
        }

        function saveLLMSelection() {
            const llmSelect = document.getElementById('llmSelect');
            localStorage.setItem('selectedLLM', llmSelect.value);
        }

        function restoreSelections() {
            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸æŠã‚’å¾©å…ƒ
            const savedAgent = localStorage.getItem('selectedAgent');
            if (savedAgent) {
                const agentSelect = document.getElementById('agentSelect');
                const agentOption = agentSelect.querySelector(`option[value="${savedAgent}"]`);
                if (agentOption) {
                    agentSelect.value = savedAgent;
                }
            }

            // LLMé¸æŠã‚’å¾©å…ƒ
            const savedLLM = localStorage.getItem('selectedLLM');
            if (savedLLM) {
                const llmSelect = document.getElementById('llmSelect');
                const llmOption = llmSelect.querySelector(`option[value="${savedLLM}"]`);
                if (llmOption) {
                    llmSelect.value = savedLLM;
                    // LLMã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚æ›´æ–°
                    updateLLMStatus();
                }
            }
        }

        // IMEå…¥åŠ›çŠ¶æ…‹ã®ç®¡ç†
        let isComposing = false;

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆé–¢æ•°
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹
        function startNewChat() {
            // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ
            currentSessionId = generateSessionId();
            localStorage.setItem('productManagementSessionId', currentSessionId);
            document.getElementById('sessionId').textContent = currentSessionId;

            // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <h4>ğŸ‘‹ ã‚ˆã†ã“ãï¼</h4>
                    <p>ä¸‹ã®å…¥åŠ›æ¬„ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚<br>
                    ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«é©åˆ‡ãªæ“ä½œç”»é¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                </div>
            `;

            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('commandInput').value = '';

            // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
            clearTempFiles();

            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMã®é¸æŠã¯ä¿æŒã™ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã«å¿œã˜ã¦ï¼‰
            // é¸æŠçŠ¶æ…‹ã¯æ—¢ã«localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ä½•ã‚‚ã—ãªã„

            // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
            loadConversationHistory();

            showNotification('æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');

        }

        // è¨­å®šãƒšãƒ¼ã‚¸ã‚’é–‹ã
        function openSettings() {
            window.location.href = '/api/settings/page';
        }

        // å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹ã
        function openHistorySidebar() {
            document.getElementById('historySidebar').classList.add('open');
            document.getElementById('historyOverlay').classList.add('open');
            loadConversationHistory();
        }

        // å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeHistorySidebar() {
            document.getElementById('historySidebar').classList.remove('open');
            document.getElementById('historyOverlay').classList.remove('open');
        }

        // ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        async function loadConversationHistory() {
            try {
                const response = await fetch(`/api/chat/history/users/all`);
                const data = await response.json();

                const historyContent = document.getElementById('historyContent');

                if (data.user_sessions && data.user_sessions.length > 0) {
                    let html = '';

                    // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    data.user_sessions.forEach(userGroup => {
                        html += `<div class="user-sessions">`;
                        html += `<div class="user-header">ğŸ‘¤ ${userGroup.user_id}</div>`;

                        userGroup.sessions.forEach(session => {
                            const isCurrentSession = session.session_id === currentSessionId;
                            const sessionClass = isCurrentSession ? 'session-item current' : 'session-item';

                            html += `
                                <div class="${sessionClass}" onclick="loadSession('${session.session_id}')">
                                    <div class="session-id">ID: ${session.session_id}</div>
                                    <div class="session-time">${new Date(session.last_activity).toLocaleString('ja-JP')}</div>
                                    <div class="session-preview">${session.first_message || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—'}</div>
                                </div>
                            `;
                        });

                        html += `</div>`;
                    });

                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = '<div class="no-history">ã¾ã ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                document.getElementById('historyContent').innerHTML = '<div class="no-history">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰é¸æŠæ™‚ï¼‰
        async function loadSession(sessionId) {
            try {
                const response = await fetch(`/api/chat/history/${sessionId}`);
                const data = await response.json();

                if (data.conversations && data.conversations.length > 0) {
                    // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æ›´æ–°
                    currentSessionId = sessionId;
                    localStorage.setItem('productManagementSessionId', currentSessionId);
                    document.getElementById('sessionId').textContent = currentSessionId;

                    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾©å…ƒ
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';

                    data.conversations.forEach(conv => {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                        if (conv.user_message) {
                            addMessage('user', conv.user_message, false, null, conv.created_at, conv.id);
                        }
                        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ ï¼ˆJSONå‡¦ç†ã‚’é©ç”¨ï¼‰
                        if (conv.agent_response) {
                            // å±¥æ­´å¾©å…ƒæ™‚ã‚‚JSONå‡¦ç†ã‚’é©ç”¨
                            const formattedResponse = formatAiResponse(conv.agent_response);
                            addMessage('assistant', formattedResponse, false, conv.trace_id, conv.created_at, conv.id);
                        }
                    });

                    // å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
                    closeHistorySidebar();

                    // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    loadConversationHistory();

                    showNotification('ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                } else {
                    showNotification('ã“ã®ä¼šè©±ã«ã¯å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                }
            } catch (error) {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showNotification('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ç”¨ã€é€šçŸ¥ãªã—ï¼‰
        async function loadSessionHistory(sessionId) {
            try {
                const response = await fetch(`/api/chat/history/${sessionId}`);
                const data = await response.json();

                if (data.conversations && data.conversations.length > 0) {
                    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾©å…ƒ
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';

                    data.conversations.forEach(conv => {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                        if (conv.user_message) {
                            addMessage('user', conv.user_message, false, null, conv.created_at, conv.id);
                        }
                        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ ï¼ˆJSONå‡¦ç†ã‚’é©ç”¨ï¼‰
                        if (conv.agent_response) {
                            // å±¥æ­´å¾©å…ƒæ™‚ã‚‚JSONå‡¦ç†ã‚’é©ç”¨
                            const formattedResponse = formatAiResponse(conv.agent_response);
                            addMessage('assistant', formattedResponse, false, conv.trace_id, conv.created_at, conv.id);
                        }
                    });

                    return true;
                }
                return false;
            } catch (error) {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                return false;
            }
        }

        // é€šçŸ¥ã‚’è¡¨ç¤º
        function showNotification(message, type = 'info') {
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ä¾¡æ ¼æƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatPricing(pricing) {
            if (!pricing) {
                return '';
            }

            const { type, input_cost, output_cost, currency, unit, note } = pricing;

            if (type === 'free') {
                return `ğŸ’° ç„¡æ–™ ${note ? `(${note})` : ''}`;
            } else if (type === 'pay_per_use') {
                const inputCostStr = input_cost === 0 ? 'ç„¡æ–™' : `$${input_cost}`;
                const outputCostStr = output_cost === 0 ? 'ç„¡æ–™' : `$${output_cost}`;

                let priceText = `ğŸ’° å…¥åŠ›: ${inputCostStr} / å‡ºåŠ›: ${outputCostStr} per ${unit}`;
                if (note) {
                    priceText += ` (${note})`;
                }
                return priceText;
            } else {
                return note ? `ğŸ’° ${note}` : '';
            }
        }

        // LLMã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateLLMStatus() {
            const select = document.getElementById('llmSelect');
            const indicator = document.getElementById('llmIndicator');
            const status = document.getElementById('llmStatus');
            const pricing = document.getElementById('llmPricing');

            const selectedOption = select.options[select.selectedIndex];
            const provider = selectedOption.dataset.provider;
            const model = selectedOption.dataset.model;
            const color = selectedOption.dataset.color;
            const description = selectedOption.dataset.description;

            // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è‰²ã‚’æ›´æ–°
            indicator.className = 'llm-indicator';
            if (color === 'green') {
                indicator.classList.add('available');
            } else if (color === 'red') {
                indicator.classList.add('unavailable');
            } else {
                indicator.classList.add('loading');
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            status.textContent = `${provider} - ${model}`;
            if (description) {
                status.title = description;
            }

            // ä¾¡æ ¼æƒ…å ±ã‚’æ›´æ–°
            try {
                const llmConfigsData = JSON.parse(llmConfigs);
                const selectedModel = llmConfigsData.find(m => m.value === select.value);
                if (selectedModel && selectedModel.pricing) {
                    pricing.innerHTML = formatPricing(selectedModel.pricing);
                } else {
                    pricing.innerHTML = '';
                }
            } catch (error) {
                console.error('ä¾¡æ ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                pricing.innerHTML = '';
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ç…§ä¼šæ©Ÿèƒ½
        let currentTable = 'products';
        let currentPage = 1;
        let currentLimit = 25;
        let currentFilters = {};
        let currentSort = { field: 'jancode', direction: 'asc' };

        // ãƒ†ãƒ¼ãƒ–ãƒ«ç…§ä¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openTableViewer() {
            document.getElementById('tableModal').classList.add('open');
            document.getElementById('tableOverlay').classList.add('open');
            switchTable('products');
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ç…§ä¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeTableViewer() {
            document.getElementById('tableModal').classList.remove('open');
            document.getElementById('tableOverlay').classList.remove('open');
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function switchTable(tableName) {
            currentTable = tableName;
            currentPage = 1;
            currentFilters = {};

            // ã‚¿ãƒ–ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.table-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.includes(getTableDisplayName(tableName))) {
                    tab.classList.add('active');
                }
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç”Ÿæˆ
            generateFilters(tableName);

            // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadTableData();
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºåã‚’å–å¾—
        function getTableDisplayName(tableName) {
            const displayNames = {
                'products': 'å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«',
                'orders': 'æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«',
                'order_items': 'æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«'
            };
            return displayNames[tableName] || tableName;
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å‹•çš„ç”Ÿæˆ
        function generateFilters(tableName) {
            const filtersContainer = document.getElementById('tableFilters');
            let filtersHtml = '<div class="filter-row">';

            if (tableName === 'products') {
                filtersHtml += `
                    <input type="text" id="filter_jancode" placeholder="JANã‚³ãƒ¼ãƒ‰" onchange="applyFilters()">
                    <input type="text" id="filter_name_jp" placeholder="æ—¥æœ¬èªå" onchange="applyFilters()">
                    <input type="text" id="filter_category" placeholder="ã‚«ãƒ†ã‚´ãƒª" onchange="applyFilters()">
                    <select id="filter_status" onchange="applyFilters()">
                        <option value="">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                        <option value="published">å…¬é–‹</option>
                        <option value="unpublished">éå…¬é–‹</option>
                    </select>
                    <input type="number" id="filter_stock_min" placeholder="æœ€å°åœ¨åº«" onchange="applyFilters()">
                    <input type="number" id="filter_stock_max" placeholder="æœ€å¤§åœ¨åº«" onchange="applyFilters()">
                `;
            } else if (tableName === 'orders') {
                filtersHtml += `
                    <input type="text" id="filter_order_id" placeholder="æ³¨æ–‡ID" onchange="applyFilters()">
                    <input type="text" id="filter_customer_name" placeholder="é¡§å®¢å" onchange="applyFilters()">
                    <select id="filter_order_status" onchange="applyFilters()">
                        <option value="">æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                        <option value="pending">ä¿ç•™ä¸­</option>
                        <option value="confirmed">ç¢ºèªæ¸ˆã¿</option>
                        <option value="processing">å‡¦ç†ä¸­</option>
                        <option value="shipped">ç™ºé€æ¸ˆã¿</option>
                        <option value="delivered">é…é”æ¸ˆã¿</option>
                        <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                    </select>
                    <select id="filter_payment_status" onchange="applyFilters()">
                        <option value="">æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                        <option value="unpaid">æœªæ‰•ã„</option>
                        <option value="paid">æ”¯æ‰•ã„æ¸ˆã¿</option>
                        <option value="refunded">è¿”é‡‘æ¸ˆã¿</option>
                    </select>
                `;
            } else if (tableName === 'order_items') {
                filtersHtml += `
                    <input type="text" id="filter_order_id" placeholder="æ³¨æ–‡ID" onchange="applyFilters()">
                    <input type="text" id="filter_jancode" placeholder="JANã‚³ãƒ¼ãƒ‰" onchange="applyFilters()">
                    <input type="text" id="filter_product_name" placeholder="å•†å“å" onchange="applyFilters()">
                    <input type="number" id="filter_quantity_min" placeholder="æœ€å°æ•°é‡" onchange="applyFilters()">
                    <input type="number" id="filter_quantity_max" placeholder="æœ€å¤§æ•°é‡" onchange="applyFilters()">
                `;
            }

            filtersHtml += '</div>';
            filtersContainer.innerHTML = filtersHtml;
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
        function applyFilters() {
            currentFilters = {};
            currentPage = 1;

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤ã‚’åé›†
            document.querySelectorAll('#tableFilters input, #tableFilters select').forEach(input => {
                if (input.value) {
                    const filterName = input.id.replace('filter_', '');
                    currentFilters[filterName] = input.value;
                }
            });

            loadTableData();
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadTableData() {
            const tableContent = document.getElementById('tableContent');
            tableContent.innerHTML = '<div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

            try {
                // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ§‹ç¯‰
                let url = `/api/table/${currentTable}?page=${currentPage}&limit=${currentLimit}`;
                url += `&order_by=${currentSort.field}&order_direction=${currentSort.direction}`;

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                Object.keys(currentFilters).forEach(key => {
                    url += `&${key}=${encodeURIComponent(currentFilters[key])}`;
                });

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    renderTable(data);
                    renderPagination(data);
                } else {
                    tableContent.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${data.detail}</div>`;
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                tableContent.innerHTML = '<div class="error">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
        function renderTable(data) {
            const tableContent = document.getElementById('tableContent');

            if (!data.data || data.data.length === 0) {
                tableContent.innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr>';

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”Ÿæˆ
            const columns = getTableColumns(currentTable);
            columns.forEach(col => {
                const sortIcon = currentSort.field === col.field ? 
                    (currentSort.direction === 'asc' ? 'â†‘' : 'â†“') : '';
                html += `<th onclick="sortTable('${col.field}')">${col.label} ${sortIcon}</th>`;
            });
            html += '<th>æ“ä½œ</th></tr></thead><tbody>';

            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ç”Ÿæˆ
            data.data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col.field] || '';
                    const isEditable = col.editable && col.field !== getPrimaryKey(currentTable);

                    if (isEditable) {
                        html += `<td><input type="${col.type || 'text'}" value="${value}" 
                                onblur="updateCell('${getPrimaryKey(currentTable)}', '${row[getPrimaryKey(currentTable)]}', '${col.field}', this.value)"></td>`;
                    } else {
                        html += `<td>${value}</td>`;
                    }
                });
                html += `<td><button onclick="deleteRow('${row[getPrimaryKey(currentTable)]}')">å‰Šé™¤</button></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            tableContent.innerHTML = html;
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—å®šç¾©ã‚’å–å¾—
        function getTableColumns(tableName) {
            const columns = {
                products: [
                    { field: 'jancode', label: 'JANã‚³ãƒ¼ãƒ‰', editable: false },
                    { field: 'name_zh', label: 'ä¸­å›½èªå', editable: true },
                    { field: 'name_en', label: 'è‹±èªå', editable: true },
                    { field: 'name_jp', label: 'æ—¥æœ¬èªå', editable: true },
                    { field: 'category', label: 'ã‚«ãƒ†ã‚´ãƒª', editable: true },
                    { field: 'status', label: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', editable: true },
                    { field: 'stock', label: 'åœ¨åº«', editable: true, type: 'number' },
                    { field: 'price', label: 'ä¾¡æ ¼', editable: true, type: 'number' },
                    { field: 'description', label: 'èª¬æ˜', editable: true }
                ],
                orders: [
                    { field: 'order_id', label: 'æ³¨æ–‡ID', editable: false },
                    { field: 'customer_id', label: 'é¡§å®¢ID', editable: true },
                    { field: 'customer_name', label: 'é¡§å®¢å', editable: true },
                    { field: 'customer_email', label: 'ãƒ¡ãƒ¼ãƒ«', editable: true },
                    { field: 'order_status', label: 'æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', editable: true },
                    { field: 'payment_status', label: 'æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', editable: true },
                    { field: 'shipping_status', label: 'é…é€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', editable: true },
                    { field: 'total_amount', label: 'åˆè¨ˆé‡‘é¡', editable: true, type: 'number' },
                    { field: 'order_date', label: 'æ³¨æ–‡æ—¥', editable: false }
                ],
                order_items: [
                    { field: 'item_id', label: 'ã‚¢ã‚¤ãƒ†ãƒ ID', editable: false },
                    { field: 'order_id', label: 'æ³¨æ–‡ID', editable: true },
                    { field: 'jancode', label: 'JANã‚³ãƒ¼ãƒ‰', editable: true },
                    { field: 'product_name', label: 'å•†å“å', editable: true },
                    { field: 'quantity', label: 'æ•°é‡', editable: true, type: 'number' },
                    { field: 'unit_price', label: 'å˜ä¾¡', editable: true, type: 'number' },
                    { field: 'total_price', label: 'å°è¨ˆ', editable: true, type: 'number' }
                ]
            };
            return columns[tableName] || [];
        }

        // ä¸»ã‚­ãƒ¼ã‚’å–å¾—
        function getPrimaryKey(tableName) {
            const primaryKeys = {
                products: 'jancode',
                orders: 'order_id',
                order_items: 'item_id'
            };
            return primaryKeys[tableName];
        }

        // ã‚½ãƒ¼ãƒˆ
        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            currentPage = 1;
            loadTableData();
        }

        // ã‚»ãƒ«æ›´æ–°
        async function updateCell(primaryKeyField, primaryKeyValue, field, value) {
            try {
                const updateData = {};
                updateData[field] = value;

                const response = await fetch(`/api/table/${currentTable}/${primaryKeyValue}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    showNotification('ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
                } else {
                    const error = await response.json();
                    showNotification(`æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.detail}`, 'error');
                    loadTableData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                }
            } catch (error) {
                console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                loadTableData();
            }
        }

        // è¡Œå‰Šé™¤
        async function deleteRow(primaryKeyValue) {
            if (!confirm('ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/api/table/${currentTable}/${primaryKeyValue}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ', 'success');
                    loadTableData(); // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    const error = await response.json();
                    showNotification(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æç”»
        function renderPagination(data) {
            const paginationContainer = document.getElementById('tablePagination');

            if (data.total_pages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let html = '<div class="pagination-info">';
            html += `${data.total}ä»¶ä¸­ ${((data.page - 1) * data.limit) + 1}-${Math.min(data.page * data.limit, data.total)}ä»¶ã‚’è¡¨ç¤º`;
            html += '</div><div class="pagination-buttons">';

            // å‰ã®ãƒšãƒ¼ã‚¸
            if (data.page > 1) {
                html += `<button onclick="changePage(${data.page - 1})">å‰ã¸</button>`;
            }

            // ãƒšãƒ¼ã‚¸ç•ªå·
            const startPage = Math.max(1, data.page - 2);
            const endPage = Math.min(data.total_pages, data.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === data.page ? 'active' : '';
                html += `<button class="${activeClass}" onclick="changePage(${i})">${i}</button>`;
            }

            // æ¬¡ã®ãƒšãƒ¼ã‚¸
            if (data.page < data.total_pages) {
                html += `<button onclick="changePage(${data.page + 1})">æ¬¡ã¸</button>`;
            }

            html += '</div>';
            paginationContainer.innerHTML = html;
        }

        // ãƒšãƒ¼ã‚¸å¤‰æ›´
        function changePage(page) {
            currentPage = page;
            loadTableData();
        }

        // è¡¨ç¤ºä»¶æ•°å¤‰æ›´
        function updateLimit() {
            const limitSelect = document.getElementById('limitSelect');
            currentLimit = parseInt(limitSelect.value);
            currentPage = 1;
            loadTableData();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒ»å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª
        function confirmReimportData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒå†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                reimportData();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒ»å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
        async function reimportData() {
            try {
                showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...', 'info');

                const response = await fetch('/api/table/clear_and_reimport', {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('ãƒ‡ãƒ¼ã‚¿ã®å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                    loadTableData(); // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    const error = await response.json();
                    showNotification(`å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showNotification('å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
        async function handleApiResponse(data) {
            let conversationId = data.conversation_id;
            let displayContent = '';

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯ç‰¹åˆ¥ãªå½¢å¼ã§è¡¨ç¤º
            if (data.error_message) {
                displayContent = formatErrorMessage(data.error_message);
            } else if (data.response) {
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¦å‡¦ç†
                displayContent = formatAiResponse(data.response);
            } else {
                displayContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }

            return {
                content: displayContent,
                conversationId: conversationId,
                traceId: data.trace_id,
                hasError: !!data.error_message
            };
        }

        // AIå›ç­”ã®JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatAiResponse(response) {
            try {
                // JSONã‹ã©ã†ã‹ã‚’åˆ¤å®š
                let jsonData;
                if (typeof response === 'string') {
                    // æ–‡å­—åˆ—ã®å ´åˆã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
                    jsonData = JSON.parse(response);
                } else if (typeof response === 'object') {
                    // ã™ã§ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                    jsonData = response;
                } else {
                    // ãã®ä»–ã®å ´åˆã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†
                    return response;
                }

                // å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (jsonData && (jsonData.html_content !== undefined || jsonData.error !== undefined || jsonData.next_actions !== undefined)) {
                    return formatStructuredResponse(jsonData);
                } else {
                    // æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãªã„å ´åˆã¯å…ƒã®å½¢å¼ã§è¿”ã™
                    return response;
                }
            } catch (e) {
                // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†
                return response;
            }
        }

        // æ§‹é€ åŒ–ã•ã‚ŒãŸAIå›ç­”ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatStructuredResponse(jsonData) {
            let html = '<div class="ai-response-container">';

            // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®ã¿
            if (jsonData.error && jsonData.error.trim() !== '') {
                html += `
                    <div class="ai-error-display">
                        <span class="error-icon">âš ï¸</span>
                        <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${jsonData.error}
                    </div>
                `;
            }

            // html_contentã‚’è¡¨ç¤º
            if (jsonData.html_content && jsonData.html_content.trim() !== '') {
                html += `
                    <div class="ai-html-content">
                        ${jsonData.html_content}
                    </div>
                `;
            }

            // ãã®ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¤ºï¼ˆerrorã€html_contentã€next_actionsä»¥å¤–ï¼‰
            const handledProperties = ['error', 'html_content', 'next_actions'];
            const otherProperties = Object.keys(jsonData).filter(key => !handledProperties.includes(key));

            if (otherProperties.length > 0) {
                html += `
                    <div class="ai-other-properties">
                        <div class="ai-other-properties-content">
                `;

                otherProperties.forEach(key => {
                    const value = jsonData[key];
                    if (value !== null && value !== undefined && value !== '') {
                        html += `
                            <div class="ai-property-item">
                                <div class="ai-property-key">${key}:</div>
                                <div class="ai-property-value">${formatPropertyValue(value)}</div>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // next_actionsã‚’è¡¨ç¤º
            if (jsonData.next_actions) {
                // next_actionsãŒæ–‡å­—åˆ—ã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
                let actionsArray = [];
                if (typeof jsonData.next_actions === 'string' && jsonData.next_actions.trim() !== '') {
                    actionsArray = [jsonData.next_actions];
                } else if (Array.isArray(jsonData.next_actions) && jsonData.next_actions.length > 0) {
                    actionsArray = jsonData.next_actions;
                }

                if (actionsArray.length > 0) {
                    html += `
                        <div class="ai-next-actions">
                            <div class="ai-next-actions-title">
                                <span>ğŸ’¡</span>
                                æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                            </div>
                            <ul class="ai-next-actions-list">
                    `;

                    actionsArray.forEach((action, index) => {
                        if (action && action.trim() !== '') {
                            html += `<li class="ai-next-actions-item"><button class="ai-next-action-link" onclick="copyActionToInput('${action.replace(/'/g, "\\'")}')">${action}</button></li>`;
                        }
                    });

                    html += `
                            </ul>
                        </div>
                    `;
                }
            }

            html += '</div>';
            return html;
        }

        // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatPropertyValue(value) {
            if (typeof value === 'object') {
                if (Array.isArray(value)) {
                    // é…åˆ—ã®å ´åˆ
                    if (value.length === 0) return '[]';
                    return '<ul class="ai-property-array">' + 
                           value.map(item => `<li>${formatPropertyValue(item)}</li>`).join('') + 
                           '</ul>';
                } else {
                    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
                    if (Object.keys(value).length === 0) return '{}';
                    let objHtml = '<div class="ai-property-object">';
                    Object.keys(value).forEach(key => {
                        objHtml += `<div class="ai-property-object-item">
                                      <span class="ai-property-object-key">${key}:</span>
                                      <span class="ai-property-object-value">${formatPropertyValue(value[key])}</span>
                                    </div>`;
                    });
                    objHtml += '</div>';
                    return objHtml;
                }
            } else if (typeof value === 'string') {
                // æ–‡å­—åˆ—ã®å ´åˆã€æ”¹è¡Œã‚’<br>ã«å¤‰æ›
                return value.replace(/\n/g, '<br>');
            } else {
                // ãã®ä»–ã®å ´åˆï¼ˆæ•°å€¤ã€çœŸå½å€¤ãªã©ï¼‰
                return String(value);
            }
        }

        // next_actionã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›æ¬„ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
        function copyActionToInput(actionText) {
            const input = document.getElementById('commandInput');
            input.value = actionText;
            input.focus();

            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            autoResize(input);

            // é€šçŸ¥ã‚’è¡¨ç¤º
            showNotification('ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›æ¬„ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç‰¹åˆ¥ãªå½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatErrorMessage(errorMessage) {
            return `<div class="error-message-container">
                <div class="error-header">
                    <span class="error-icon">âš ï¸</span>
                    <span class="error-title">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>
                </div>
                <div class="error-content">
                    ${errorMessage.replace(/\n/g, '<br>')}
                </div>
                <div class="error-actions">
                    <button class="error-retry-btn" onclick="retryLastMessage()">å†è©¦è¡Œ</button>
                </div>
            </div>`;
        }

        // éŸ³å£°éŒ²éŸ³é–¢é€£ã®å¤‰æ•°
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // éŸ³å£°éŒ²éŸ³ã®é–‹å§‹/åœæ­¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
        async function toggleVoiceRecording() {
            const voiceBtn = document.getElementById('voiceBtn');

            if (isRecording) {
                stopVoiceRecording();
            } else {
                await startVoiceRecording();
            }
        }

        // éŸ³å£°éŒ²éŸ³ã‚’é–‹å§‹
        async function startVoiceRecording() {
            const voiceBtn = document.getElementById('voiceBtn');

            try {
                // ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // MediaRecorderã‚’åˆæœŸåŒ–
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                // éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                // éŒ²éŸ³çµ‚äº†æ™‚ã®å‡¦ç†
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processVoiceInput(audioBlob);

                    // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                    stream.getTracks().forEach(track => track.stop());
                };

                // éŒ²éŸ³é–‹å§‹
                mediaRecorder.start();
                isRecording = true;

                // UIã‚’æ›´æ–°
                voiceBtn.classList.add('recording');
                voiceBtn.title = 'éŒ²éŸ³åœæ­¢';
                voiceBtn.innerHTML = 'â¹ï¸';

                showNotification('éŸ³å£°éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœæ­¢ã—ã¦ãã ã•ã„ã€‚', 'info');

            } catch (error) {
                console.error('éŸ³å£°éŒ²éŸ³ã®é–‹å§‹ã«å¤±æ•—:', error);
                showNotification('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        }

        // éŸ³å£°éŒ²éŸ³ã‚’åœæ­¢
        function stopVoiceRecording() {
            const voiceBtn = document.getElementById('voiceBtn');

            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // UIã‚’æ›´æ–°
                voiceBtn.classList.remove('recording');
                voiceBtn.classList.add('processing');
                voiceBtn.title = 'éŸ³å£°å‡¦ç†ä¸­...';
                voiceBtn.innerHTML = 'â³';
                voiceBtn.disabled = true;

                showNotification('éŸ³å£°ã‚’å‡¦ç†ä¸­ã§ã™...', 'info');
            }
        }

        // éŸ³å£°å…¥åŠ›ã‚’å‡¦ç†
        async function processVoiceInput(audioBlob) {
            const voiceBtn = document.getElementById('voiceBtn');

            try {
                // FormDataã‚’ä½œæˆ
                const formData = new FormData();
                formData.append('audio_file', audioBlob, 'recording.wav');
                formData.append('session_id', currentSessionId);
                formData.append('user_id', currentUserId);
                formData.append('agent_type', document.getElementById('agentSelect').value);
                formData.append('llm_type', document.getElementById('llmSelect').value);

                // éŸ³å£°å‡¦ç†APIã‚’å‘¼ã³å‡ºã—
                const response = await fetch('/api/chat/voice_input', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // å¤‰æ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›æ¬„ã«è¨­å®š
                const input = document.getElementById('commandInput');
                input.value = data.transcribed_text;
                autoResize(input);

                // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                if (data.agent_response) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const userMessageId = addMessage('user', data.transcribed_text, false, null, new Date().toISOString());

                    // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å‡¦ç†
                    const processedResponse = await handleApiResponse(data.agent_response);

                    // conversation IDãŒå–å¾—ã§ããŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚‚è¨­å®š
                    if (processedResponse.conversationId) {
                        const userMessageElement = document.getElementById(userMessageId);
                        if (userMessageElement) {
                            userMessageElement.setAttribute('data-conversation-id', processedResponse.conversationId);
                        }
                    }

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
                    addMessage('assistant', processedResponse.content, false, processedResponse.traceId, new Date().toISOString(), processedResponse.conversationId, processedResponse.hasError);

                    // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                    input.value = '';
                    autoResize(input);
                }

                showNotification('éŸ³å£°å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');

            } catch (error) {
                console.error('éŸ³å£°å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showNotification(`éŸ³å£°å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            } finally {
                // UIã‚’å…ƒã«æˆ»ã™
                voiceBtn.classList.remove('processing');
                voiceBtn.title = 'éŸ³å£°å…¥åŠ›';
                voiceBtn.innerHTML = 'ğŸ¤';
                voiceBtn.disabled = false;
            }
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼
        function triggerImageUpload() {
            const imageInput = document.getElementById('imageInput');
            imageInput.click();
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å‡¦ç†ï¼ˆä¸€æ™‚ä¿å­˜ï¼‰
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showNotification('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JPG, PNG, GIF, WebP ã®ã„ãšã‚Œã‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚10MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            const imageBtn = document.getElementById('imageBtn');

            try {
                // UIã‚’æ›´æ–°ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­çŠ¶æ…‹ï¼‰
                imageBtn.classList.add('uploading');
                imageBtn.disabled = true;
                imageBtn.title = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

                // FormDataã‚’ä½œæˆï¼ˆä¸€æ™‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', currentSessionId);
                formData.append('user_id', currentUserId);

                // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰APIã‚’å‘¼ã³å‡ºã—
                const response = await fetch('/api/chat/temp_file_upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿å­˜
                const tempFile = {
                    file_id: data.file_id,
                    filename: data.filename,
                    file_size: data.file_size,
                    upload_time: new Date().toISOString()
                };
                tempUploadedFiles.push(tempFile);

                // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
                updateTempFileDisplay();

                showNotification(`ãƒ•ã‚¡ã‚¤ãƒ« "${data.filename}" ãŒä¸€æ™‚ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯éŸ³å£°ã§æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`, 'success');

            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                showNotification(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            } finally {
                // UIã‚’å…ƒã«æˆ»ã™
                imageBtn.classList.remove('uploading');
                imageBtn.disabled = false;
                imageBtn.title = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';

                // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                event.target.value = '';
            }
        }

        // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
        function updateTempFileDisplay() {
            const inputContainer = document.querySelector('.input-container');

            // æ—¢å­˜ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚’å‰Šé™¤
            const existingDisplay = document.getElementById('tempFileDisplay');
            if (existingDisplay) {
                existingDisplay.remove();
            }

            // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºã‚’ä½œæˆ
            if (tempUploadedFiles.length > 0) {
                const tempFileDisplay = document.createElement('div');
                tempFileDisplay.id = 'tempFileDisplay';
                tempFileDisplay.className = 'temp-file-display';

                const fileList = tempUploadedFiles.map(file => {
                    return `
                        <div class="temp-file-item" data-file-id="${file.file_id}">
                            <span class="temp-file-icon">ğŸ“</span>
                            <span class="temp-file-name">${file.filename}</span>
                            <button class="temp-file-remove" onclick="removeTempFile('${file.file_id}')" title="å‰Šé™¤">Ã—</button>
                        </div>
                    `;
                }).join('');

                tempFileDisplay.innerHTML = `
                    <div class="temp-file-header">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«:</div>
                    <div class="temp-file-list">${fileList}</div>
                `;

                // å…¥åŠ›ã‚³ãƒ³ãƒ†ãƒŠã®å‰ã«æŒ¿å…¥
                inputContainer.parentNode.insertBefore(tempFileDisplay, inputContainer);
            }
        }

        // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        async function removeTempFile(fileId) {
            try {
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                const formData = new FormData();
                formData.append('file_id', fileId);
                formData.append('session_id', currentSessionId);
                formData.append('user_id', currentUserId);

                const response = await fetch('/api/chat/temp_file_delete', {
                    method: 'DELETE',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®å‰Šé™¤ãŒæˆåŠŸã—ãŸå ´åˆã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚‚å‰Šé™¤
                tempUploadedFiles = tempUploadedFiles.filter(file => file.file_id !== fileId);
                updateTempFileDisplay();
                showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ', 'success');

            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showNotification(`ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }

        // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆé–‹å§‹æ™‚ã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
        function clearTempFiles() {
            tempUploadedFiles = [];
            updateTempFileDisplay();
        }

        // æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†è©¦è¡Œ
        function retryLastMessage() {
            const messages = document.querySelectorAll('.message.user');
            if (messages.length > 0) {
                const lastUserMessage = messages[messages.length - 1];
                const messageText = lastUserMessage.querySelector('.message-text');
                if (messageText) {
                    document.getElementById('commandInput').value = messageText.textContent;
                    sendMessage();
                }
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ä¿®æ­£ç‰ˆ
        async function sendMessage() {
            const input = document.getElementById('commandInput');
            const message = input.value.trim();

            if (!message) return;

            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ™‚çš„ã«è¡¨ç¤ºï¼ˆconversation IDã¯å¾Œã§æ›´æ–°ï¼‰
            const userMessageId = addMessage('user', message, false, null, new Date().toISOString());
            input.value = '';
            autoResize(input);

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingId = addMessage('assistant', '', true);

            try {
                // é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMã‚¿ã‚¤ãƒ—ã‚’å–å¾—
                const selectedAgent = document.getElementById('agentSelect').value;
                const llmModel = document.getElementById('llmSelect').value;

                let data;

                // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
                if (tempUploadedFiles.length > 0) {
                    // FormDataã‚’ä½œæˆ
                    const formData = new FormData();
                    formData.append('message', message);
                    formData.append('session_id', currentSessionId);
                    formData.append('user_id', currentUserId);
                    formData.append('agent_type', selectedAgent);
                    formData.append('llm_type', llmModel);

                    // ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¿½åŠ 
                    const fileIds = tempUploadedFiles.map(file => file.file_id).join(',');
                    formData.append('file_ids', fileIds);

                    const response = await fetch('/api/chat/process_message_with_files', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                    }

                    const responseData = await response.json();

                    // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¿œç­”ã‚’å–å¾—
                    if (responseData.agent_response) {
                        data = responseData.agent_response;
                    } else {
                        throw new Error('ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¿œç­”ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    }

                    // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢ï¼ˆå‡¦ç†å®Œäº†å¾Œï¼‰
                    clearTempFiles();

                } else {
                    // é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãªã—ï¼‰
                    let apiUrl;
                    if (selectedAgent === 'AgentDirector') {
                        apiUrl = '/api/agent/director-agent/chat';
                    } else {
                        apiUrl = '/api/agent/single-agent/chat';
                    }

                    const requestBody = {
                        message: message,
                        user_id: currentUserId,
                        session_id: currentSessionId,
                        llm_type: llmModel,
                        agent_type: selectedAgent,
                        context: {}
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    data = await response.json();
                }

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
                const processedResponse = await handleApiResponse(data);

                // conversation IDãŒå–å¾—ã§ããŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚‚è¨­å®š
                if (processedResponse.conversationId) {
                    const userMessageElement = document.getElementById(userMessageId);
                    if (userMessageElement) {
                        userMessageElement.setAttribute('data-conversation-id', processedResponse.conversationId);
                    }
                }

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                removeMessage(loadingId);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã«å¿œã˜ã¦å‡¦ç†ï¼‰
                addMessage('assistant', processedResponse.content, false, processedResponse.traceId, new Date().toISOString(), processedResponse.conversationId, processedResponse.hasError);

            } catch (error) {
                console.error('Error:', error);
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                removeMessage(loadingId);
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const errorContent = formatErrorMessage(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                addMessage('assistant', errorContent, false, null, new Date().toISOString(), null, true);
            } finally {
                // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Execute scripts in dynamically inserted HTML content
        function executeScriptsInElement(element) {
            const scripts = element.querySelectorAll('script');
            scripts.forEach(script => {
                try {
                    // Create a new script element and copy attributes
                    const newScript = document.createElement('script');

                    // Copy all attributes from the original script
                    Array.from(script.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });

                    // Set the script content
                    if (script.src) {
                        // External script - set src
                        newScript.src = script.src;
                    } else {
                        // Inline script - set text content
                        newScript.textContent = script.textContent;
                    }

                    // Remove the original script and add the new one to execute it
                    script.parentNode.replaceChild(newScript, script);
                } catch (error) {
                    console.error('Error executing script:', error);
                }
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå¯¾å¿œç‰ˆï¼‰
        function addMessage(role, content, isLoading = false, traceId = null, timestamp = null, conversationId = null, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.id = messageId;

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            if (isError) {
                messageDiv.classList.add('error-message');
            }

            // conversation IDã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿å­˜
            if (conversationId) {
                messageDiv.setAttribute('data-conversation-id', conversationId);
            }

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isLoading) {
                contentDiv.innerHTML = '<div class="loading">å›ç­”ã‚’ç”Ÿæˆä¸­...</div>';
            } else {
                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
                let contentHTML = '';
                if (timestamp) {
                    contentHTML += `<div class="message-timestamp">${new Date(timestamp).toLocaleString('ja-JP')}</div>`;
                }

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤ºã€é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¤‰æ›
                let formattedContent;
                if (isError) {
                    formattedContent = content; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã™ã§ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿
                } else if (content.includes('ai-html-content') || content.includes('ai-response-container')) {
                    // HTML content (structured response) ã®å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤ºï¼ˆnewline to br conversion ã‚’é©ç”¨ã—ãªã„ï¼‰
                    formattedContent = content;
                } else {
                    formattedContent = content
                        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                        .replace(/`([^`]+)`/g, '<code>$1</code>')
                        .replace(/\n/g, '<br>');
                }

                contentHTML += `<div class="message-text">${formattedContent}</div>`;
                contentDiv.innerHTML = contentHTML;

                // Execute any scripts in the inserted HTML content
                executeScriptsInElement(contentDiv);

                // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯è¿½åŠ ã—ãªã„ï¼‰
                if (role === 'assistant' && !isLoading && !isError) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';

                    // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'action-btn copy';
                    copyBtn.innerHTML = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                    copyBtn.onclick = () => copyMessage(content);

                    // å†ç”Ÿæˆãƒœã‚¿ãƒ³
                    const regenerateBtn = document.createElement('button');
                    regenerateBtn.className = 'action-btn regenerate';
                    regenerateBtn.innerHTML = 'ğŸ”„ å†ç”Ÿæˆ';
                    regenerateBtn.onclick = () => regenerateMessage(messageId, conversationId);

                    // è‰¯ã„ãƒœã‚¿ãƒ³
                    const goodBtn = document.createElement('button');
                    goodBtn.className = 'action-btn good';
                    goodBtn.innerHTML = 'ğŸ‘ è‰¯ã„';
                    goodBtn.onclick = () => evaluateMessage(traceId, 'good', messageId);

                    // æ‚ªã„ãƒœã‚¿ãƒ³
                    const badBtn = document.createElement('button');
                    badBtn.className = 'action-btn bad';
                    badBtn.innerHTML = 'ğŸ‘ æ‚ªã„';
                    badBtn.onclick = () => evaluateMessage(traceId, 'bad', messageId);

                    actionsDiv.appendChild(copyBtn);
                    actionsDiv.appendChild(regenerateBtn);
                    actionsDiv.appendChild(goodBtn);
                    actionsDiv.appendChild(badBtn);

                    contentDiv.appendChild(actionsDiv);
                }
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return messageId;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        function removeMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.remove();
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼
        async function copyMessage(content) {
            try {
                // HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';

                await navigator.clipboard.writeText(plainText);
                showNotification('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†ç”Ÿæˆ
        async function regenerateMessage(messageId, conversationId) {
            try {
                if (!conversationId) {
                    showNotification('å†ç”Ÿæˆã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®conversation IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                // ç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’å–å¾—ã—ã¦ä½ç½®ã‚’è¨˜éŒ²
                const currentMessageElement = document.getElementById(messageId);
                if (!currentMessageElement) {
                    showNotification('å†ç”Ÿæˆã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                // å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆconversation IDã‚’ä½¿ç”¨ï¼‰
                const chatMessages = document.getElementById('chatMessages');
                const messages = chatMessages.querySelectorAll('.message');
                let targetUserMessage = '';
                let userMessageElement = null;

                // conversation IDã«å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™
                for (let i = 0; i < messages.length; i++) {
                    const messageElement = messages[i];
                    const msgConversationId = messageElement.getAttribute('data-conversation-id');

                    if (msgConversationId == conversationId && messageElement.classList.contains('user')) {
                        const contentDiv = messageElement.querySelector('.message-content .message-text');
                        targetUserMessage = contentDiv ? (contentDiv.textContent || contentDiv.innerText || '') : '';
                        userMessageElement = messageElement;
                        break;
                    }
                }

                if (!targetUserMessage) {
                    showNotification('å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                // ç¾åœ¨ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½ç½®ã‚’è¨˜éŒ²
                const nextSibling = currentMessageElement.nextSibling;
                const parentElement = currentMessageElement.parentElement;

                // ç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
                removeMessage(messageId);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’åŒã˜ä½ç½®ã«æŒ¿å…¥
                const loadingMessageDiv = document.createElement('div');
                loadingMessageDiv.className = 'message assistant';
                loadingMessageDiv.id = 'loading_' + Date.now();

                const loadingAvatar = document.createElement('div');
                loadingAvatar.className = 'message-avatar';
                loadingAvatar.textContent = 'ğŸ¤–';

                const loadingContentDiv = document.createElement('div');
                loadingContentDiv.className = 'message-content';
                loadingContentDiv.innerHTML = '<div class="loading">å›ç­”ã‚’å†ç”Ÿæˆä¸­...</div>';

                loadingMessageDiv.appendChild(loadingAvatar);
                loadingMessageDiv.appendChild(loadingContentDiv);

                // å…ƒã®ä½ç½®ã«æŒ¿å…¥
                if (nextSibling) {
                    parentElement.insertBefore(loadingMessageDiv, nextSibling);
                } else {
                    parentElement.appendChild(loadingMessageDiv);
                }

                // é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—
                const selectedAgent = document.getElementById('agentSelect').value;
                const llmModel = document.getElementById('llmSelect').value;

                const response = await fetch('/api/chat/regenerate_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        query: targetUserMessage,
                        session_id: currentSessionId,
                        user_id: currentUserId,
                        agent_type: selectedAgent,
                        llm_type: llmModel,
                        conversation_id: conversationId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ï¼ˆsendMessageã¨åŒã˜å‡¦ç†ã‚’é©ç”¨ï¼‰
                const processedResponse = await handleApiResponse(data);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                loadingMessageDiv.remove();

                // æ–°ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å…ƒã®ä½ç½®ã«è¡¨ç¤º
                const newMessageDiv = document.createElement('div');
                newMessageDiv.className = 'message assistant';
                newMessageDiv.id = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                // conversation IDã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿å­˜
                if (conversationId) {
                    newMessageDiv.setAttribute('data-conversation-id', conversationId);
                }

                const newAvatar = document.createElement('div');
                newAvatar.className = 'message-avatar';
                newAvatar.textContent = 'ğŸ¤–';

                const newContentDiv = document.createElement('div');
                newContentDiv.className = 'message-content';

                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
                let contentHTML = `<div class="message-timestamp">${new Date().toLocaleString('ja-JP')}</div>`;

                // å‡¦ç†æ¸ˆã¿ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½¿ç”¨
                let formattedContent = processedResponse.content || 'å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';

                contentHTML += `<div class="message-text">${formattedContent}</div>`;
                newContentDiv.innerHTML = contentHTML;

                // Execute any scripts in the inserted HTML content
                executeScriptsInElement(newContentDiv);

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';

                // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn copy';
                copyBtn.innerHTML = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                copyBtn.onclick = () => copyMessage(processedResponse.content || 'å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');

                // å†ç”Ÿæˆãƒœã‚¿ãƒ³
                const regenerateBtn = document.createElement('button');
                regenerateBtn.className = 'action-btn regenerate';
                regenerateBtn.innerHTML = 'ğŸ”„ å†ç”Ÿæˆ';
                regenerateBtn.onclick = () => regenerateMessage(newMessageDiv.id, conversationId);

                // è‰¯ã„ãƒœã‚¿ãƒ³
                const goodBtn = document.createElement('button');
                goodBtn.className = 'action-btn good';
                goodBtn.innerHTML = 'ğŸ‘ è‰¯ã„';
                goodBtn.onclick = () => evaluateMessage(data.trace_id, 'good', newMessageDiv.id);

                // æ‚ªã„ãƒœã‚¿ãƒ³
                const badBtn = document.createElement('button');
                badBtn.className = 'action-btn bad';
                badBtn.innerHTML = 'ğŸ‘ æ‚ªã„';
                badBtn.onclick = () => evaluateMessage(data.trace_id, 'bad', newMessageDiv.id);

                actionsDiv.appendChild(copyBtn);
                actionsDiv.appendChild(regenerateBtn);
                actionsDiv.appendChild(goodBtn);
                actionsDiv.appendChild(badBtn);

                newContentDiv.appendChild(actionsDiv);
                newMessageDiv.appendChild(newAvatar);
                newMessageDiv.appendChild(newContentDiv);

                // å…ƒã®ä½ç½®ã«æŒ¿å…¥
                if (nextSibling) {
                    parentElement.insertBefore(newMessageDiv, nextSibling);
                } else {
                    parentElement.appendChild(newMessageDiv);
                }

                showNotification('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸ', 'success');

            } catch (error) {
                console.error('å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showNotification('å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è©•ä¾¡
        async function evaluateMessage(traceId, evaluation, messageId) {
            if (!traceId) {
                showNotification('è©•ä¾¡ã§ãã¾ã›ã‚“ï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰', 'error');
                return;
            }

            try {
                const response = await fetch('/api/chat/evaluate_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        trace_id: traceId,
                        evaluation: evaluation,
                        user_id: currentUserId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                const messageElement = document.getElementById(messageId);
                if (messageElement) {
                    const actionBtns = messageElement.querySelectorAll('.action-btn.good, .action-btn.bad');
                    actionBtns.forEach(btn => {
                        btn.style.opacity = '0.5';
                        btn.disabled = true;
                    });

                    // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    const selectedBtn = messageElement.querySelector(`.action-btn.${evaluation}`);
                    if (selectedBtn) {
                        selectedBtn.style.opacity = '1';
                        selectedBtn.style.fontWeight = 'bold';
                    }
                }

                const evaluationText = evaluation === 'good' ? 'è‰¯ã„' : 'æ‚ªã„';
                showNotification(`è©•ä¾¡ã€Œ${evaluationText}ã€ã‚’é€ä¿¡ã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                console.error('è©•ä¾¡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showNotification('è©•ä¾¡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // å…¥åŠ›å‡¦ç†
        function handleInput(e) {
            autoResize(e.target);
        }

        // ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // Shift+Enter: æ”¹è¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼‰
                    return;
                } else {
                    // Enter: é€ä¿¡ï¼ˆIMEå…¥åŠ›ä¸­ã§ãªã„å ´åˆã‹ã¤é€ä¿¡ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
                    if (!isComposing) {
                        e.preventDefault();
                        // é€ä¿¡ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é€ä¿¡ã—ãªã„
                        const sendBtn = document.getElementById('sendBtn');
                        if (!sendBtn.disabled) {
                            sendMessage();
                        }
                    }
                }
            }
        }

        // IMEå…¥åŠ›é–‹å§‹
        function handleCompositionStart(e) {
            isComposing = true;
        }

        // IMEå…¥åŠ›æ›´æ–°
        function handleCompositionUpdate(e) {
            isComposing = true;
        }

        // IMEå…¥åŠ›çµ‚äº†
        function handleCompositionEnd(e) {
            isComposing = false;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('llmSelect').addEventListener('change', function() {
            updateLLMStatus();
            saveLLMSelection();
        });

        document.getElementById('agentSelect').addEventListener('change', saveAgentSelection);

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const commandInput = document.getElementById('commandInput');

        // åŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // å…¥åŠ›çŠ¶æ…‹ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã®è¿½åŠ inputã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        commandInput.addEventListener('input', handleInput);
        commandInput.addEventListener('keypress', handleKeyDown);

        // IMEã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆMacæœ€é©åŒ–ï¼‰
        commandInput.addEventListener('compositionstart', handleCompositionStart);
        commandInput.addEventListener('compositionupdate', handleCompositionUpdate);
        commandInput.addEventListener('compositionend', handleCompositionEnd);

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°
        commandInput.addEventListener('focus', function() {
            this.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
        });

        commandInput.addEventListener('blur', function() {
            this.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
        });

        // ESCã‚­ãƒ¼ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHistorySidebar();
            }
        });

        // ä½¿ç”¨ä¾‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹æ©Ÿèƒ½
        function toggleExamplesSection() {
            const examplesSection = document.getElementById('examplesSection');
            const toggleIcon = document.querySelector('.toggle-icon');
            
            // çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            examplesSection.classList.toggle('collapsed');
            
            // çŠ¶æ…‹ã‚’ä¿å­˜
            const isCollapsed = examplesSection.classList.contains('collapsed');
            localStorage.setItem('examplesSectionCollapsed', isCollapsed);
            
            // ãƒœã‚¿ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const toggleBtn = document.getElementById('toggleExamplesBtn');
            toggleBtn.title = isCollapsed ? "ä½¿ç”¨ä¾‹ã‚’å±•é–‹ã™ã‚‹" : "ä½¿ç”¨ä¾‹ã‚’æŠ˜ã‚ŠãŸãŸã‚€";
        }
        
        // ä½¿ç”¨ä¾‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
        function restoreExamplesSection() {
            const examplesSection = document.getElementById('examplesSection');
            const isCollapsed = localStorage.getItem('examplesSectionCollapsed') === 'true';
            
            if (isCollapsed) {
                examplesSection.classList.add('collapsed');
                
                // ãƒœã‚¿ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
                const toggleBtn = document.getElementById('toggleExamplesBtn');
                toggleBtn.title = "ä½¿ç”¨ä¾‹ã‚’å±•é–‹ã™ã‚‹";
            }
        }
        
        // ä½¿ç”¨ä¾‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.getElementById('toggleExamplesBtn').addEventListener('click', toggleExamplesSection);

        // åˆæœŸåŒ–
        restoreSelections();
        updateLLMStatus();
        restoreExamplesSection();

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        window.addEventListener('load', async function() {
            loadConversationHistory();

            // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒã‚ã‚‹å ´åˆã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¼šè©±å±¥æ­´ã‚’è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿
            if (currentSessionId && currentSessionId !== '') {
                try {
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¼šè©±å±¥æ­´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const response = await fetch(`/api/chat/history/${currentSessionId}`);
                    const data = await response.json();

                    if (data.conversations && data.conversations.length > 0) {
                        // ä¼šè©±å±¥æ­´ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿
                        await loadSessionHistory(currentSessionId);
                        console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¼šè©±å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', currentSessionId);
                    }
                } catch (error) {
                    console.log('æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¼šè©±å±¥æ­´èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ:', error);
                }
            }

            commandInput.focus(); // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        });

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†
        window.addEventListener('resize', function() {
            autoResize(commandInput);
        });
    </script>
</body>
</html>
