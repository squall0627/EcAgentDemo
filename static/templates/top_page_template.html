<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECå•†å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <!-- å¤–éƒ¨CSSãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="/static/css/top_page_styles.css">
</head>
<body>
    <!-- å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="history-overlay" id="historyOverlay" onclick="closeHistorySidebar()"></div>

    <!-- å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="history-sidebar" id="historySidebar">
        <div class="history-header">
            <h3 style="margin: 0;">ğŸ“– ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h3>
            <button class="history-close-btn" onclick="closeHistorySidebar()">Ã—</button>
        </div>
        <div class="history-content" id="historyContent">
            <div class="no-history">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 style="margin: 0; color: #343a40;">ğŸ¤– ECå•†å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                    <p style="margin: 10px 0 0 0; color: #6c757d;">è‡ªç„¶è¨€èªã§AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å¯¾è©±ã—ã¦å•†å“ã‚’ç®¡ç†ã§ãã¾ã™</p>
                </div>
                <div class="header-actions">
                    <button class="settings-btn" onclick="openSettings()" title="ã‚·ã‚¹ãƒ†ãƒ è¨­å®š">
                        âš™ï¸
                    </button>
                </div>
            </div>
        </div>

        <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã¨å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
        <div class="session-info">
            <span>ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: <span id="sessionId"></span></span>
            <div class="session-actions">
                <button class="history-btn" onclick="openHistorySidebar()">å±¥æ­´è¡¨ç¤º</button>
                <button class="new-chat-btn" onclick="startNewChat()">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</button>
            </div>
        </div>

        <!-- ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="chat-container">
            <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆè¨­å®šã‚¨ãƒªã‚¢ï¼‰ -->
            <div class="chat-header">
                <div class="config-grid">
                    <!-- Left column: Agent selection -->
                    <div class="config-column">
                        <div class="config-label">ğŸ§  ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:</div>
                        <select id="agentSelect" class="agent-select">
                            {{AGENT_OPTIONS}}
                        </select>
                    </div>

                    <!-- Center column: LLM selection -->
                    <div class="config-column">
                        <div class="config-label">ğŸ¤– LLM:</div>
                        <select id="llmSelect" class="llm-select">
                            {{LLM_OPTIONS}}
                        </select>
                    </div>

                    <!-- Right column: Selected LLM status and pricing -->
                    <div class="config-column">
                        <div class="llm-status">
                            <span class="llm-indicator" id="llmIndicator"></span>
                            <span id="llmStatus">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                        <div class="llm-pricing" id="llmPricing">
                            <!-- ä¾¡æ ¼æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                </div>

                <div class="examples">
                    <strong>ğŸ’¡ ä½¿ç”¨ä¾‹:</strong>
                    <ul>
                        <li>"ã‚³ãƒ¼ãƒ’ãƒ¼å•†å“ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„"</li>
                        <li>"åœ¨åº«ãŒå°‘ãªã„å•†å“ã‚’æ£šä¸Šã’ã—ã¦ãã ã•ã„"</li>
                        <li>"JANã‚³ãƒ¼ãƒ‰123ã®å•†å“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„"</li>
                    </ul>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
            <div id="chatMessages" class="chat-messages">
                <div class="welcome-message">
                    <h4>ğŸ‘‹ ã‚ˆã†ã“ãï¼</h4>
                    <p>ä¸‹ã®å…¥åŠ›æ¬„ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚<br>
                    ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«é©åˆ‡ãªæ“ä½œç”»é¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="chat-input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="commandInput" 
                            class="chat-input" 
                            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                            maxlength="2000"
                            rows="1"></textarea>
                        <button id="sendBtn" class="send-button" onclick="sendMessage()" title="é€ä¿¡ (Enter)">
                            â¤
                        </button>
                    </div>
                </div>
                <div class="input-hint">
                    Shift+Enter: æ”¹è¡Œ | Enter: é€ä¿¡ | æœ€å¤§2000æ–‡å­—
                </div>
            </div>
        </div>
    </div>

    <script>
        // LLMè¨­å®šï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
        const llmConfigs = "{{LLM_JS_CONFIG}}";

        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®šï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
        const agentConfigs = "{{AGENT_JS_CONFIG}}";

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯èªè¨¼ã‹ã‚‰å–å¾—ï¼‰
        const currentUserId = 'default_user';

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç®¡ç†
        let currentSessionId = localStorage.getItem('productManagementSessionId');
        if (!currentSessionId) {
            currentSessionId = generateSessionId();
            localStorage.setItem('productManagementSessionId', currentSessionId);
        }
        document.getElementById('sessionId').textContent = currentSessionId;

        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMé¸æŠã®ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½
        function saveAgentSelection() {
            const agentSelect = document.getElementById('agentSelect');
            localStorage.setItem('selectedAgent', agentSelect.value);
        }

        function saveLLMSelection() {
            const llmSelect = document.getElementById('llmSelect');
            localStorage.setItem('selectedLLM', llmSelect.value);
        }

        function restoreSelections() {
            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸æŠã‚’å¾©å…ƒ
            const savedAgent = localStorage.getItem('selectedAgent');
            if (savedAgent) {
                const agentSelect = document.getElementById('agentSelect');
                const agentOption = agentSelect.querySelector(`option[value="${savedAgent}"]`);
                if (agentOption) {
                    agentSelect.value = savedAgent;
                }
            }

            // LLMé¸æŠã‚’å¾©å…ƒ
            const savedLLM = localStorage.getItem('selectedLLM');
            if (savedLLM) {
                const llmSelect = document.getElementById('llmSelect');
                const llmOption = llmSelect.querySelector(`option[value="${savedLLM}"]`);
                if (llmOption) {
                    llmSelect.value = savedLLM;
                    // LLMã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚æ›´æ–°
                    updateLLMStatus();
                }
            }
        }

        // IMEå…¥åŠ›çŠ¶æ…‹ã®ç®¡ç†
        let isComposing = false;

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆé–¢æ•°
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹
        function startNewChat() {
            // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ
            currentSessionId = generateSessionId();
            localStorage.setItem('productManagementSessionId', currentSessionId);
            document.getElementById('sessionId').textContent = currentSessionId;

            // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <h4>ğŸ‘‹ ã‚ˆã†ã“ãï¼</h4>
                    <p>ä¸‹ã®å…¥åŠ›æ¬„ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚<br>
                    ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«é©åˆ‡ãªæ“ä½œç”»é¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                </div>
            `;

            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('commandInput').value = '';

            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMã®é¸æŠã¯ä¿æŒã™ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã«å¿œã˜ã¦ï¼‰
            // é¸æŠçŠ¶æ…‹ã¯æ—¢ã«localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ä½•ã‚‚ã—ãªã„

            // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
            loadConversationHistory();

            showNotification('æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');

        }

        // è¨­å®šãƒšãƒ¼ã‚¸ã‚’é–‹ã
        function openSettings() {
            window.location.href = '/api/settings/page';
        }

        // å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹ã
        function openHistorySidebar() {
            document.getElementById('historySidebar').classList.add('open');
            document.getElementById('historyOverlay').classList.add('open');
            loadConversationHistory();
        }

        // å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeHistorySidebar() {
            document.getElementById('historySidebar').classList.remove('open');
            document.getElementById('historyOverlay').classList.remove('open');
        }

        // ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        async function loadConversationHistory() {
            try {
                const response = await fetch(`/api/chat/history/users/all`);
                const data = await response.json();

                const historyContent = document.getElementById('historyContent');

                if (data.user_sessions && data.user_sessions.length > 0) {
                    let html = '';

                    // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    data.user_sessions.forEach(userGroup => {
                        html += `<div class="user-sessions">`;
                        html += `<div class="user-header">ğŸ‘¤ ${userGroup.user_id}</div>`;

                        userGroup.sessions.forEach(session => {
                            const isCurrentSession = session.session_id === currentSessionId;
                            const sessionClass = isCurrentSession ? 'session-item current' : 'session-item';

                            html += `
                                <div class="${sessionClass}" onclick="loadSession('${session.session_id}')">
                                    <div class="session-id">ID: ${session.session_id}</div>
                                    <div class="session-time">${new Date(session.last_activity).toLocaleString('ja-JP')}</div>
                                    <div class="session-preview">${session.first_message || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—'}</div>
                                </div>
                            `;
                        });

                        html += `</div>`;
                    });

                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = '<div class="no-history">ã¾ã ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                document.getElementById('historyContent').innerHTML = '<div class="no-history">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰é¸æŠæ™‚ï¼‰
        async function loadSession(sessionId) {
            try {
                const response = await fetch(`/api/chat/history/${sessionId}`);
                const data = await response.json();

                if (data.conversations && data.conversations.length > 0) {
                    // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æ›´æ–°
                    currentSessionId = sessionId;
                    localStorage.setItem('productManagementSessionId', currentSessionId);
                    document.getElementById('sessionId').textContent = currentSessionId;

                    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾©å…ƒ
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';

                    data.conversations.forEach(conv => {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                        if (conv.user_message) {
                            addMessage('user', conv.user_message, false, null, conv.created_at, conv.id);
                        }
                        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ ï¼ˆJSONå‡¦ç†ã‚’é©ç”¨ï¼‰
                        if (conv.agent_response) {
                            // å±¥æ­´å¾©å…ƒæ™‚ã‚‚JSONå‡¦ç†ã‚’é©ç”¨
                            const formattedResponse = formatAiResponse(conv.agent_response);
                            addMessage('assistant', formattedResponse, false, conv.trace_id, conv.created_at, conv.id);
                        }
                    });

                    // å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
                    closeHistorySidebar();

                    // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    loadConversationHistory();

                    showNotification('ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                } else {
                    showNotification('ã“ã®ä¼šè©±ã«ã¯å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                }
            } catch (error) {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showNotification('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ç”¨ã€é€šçŸ¥ãªã—ï¼‰
        async function loadSessionHistory(sessionId) {
            try {
                const response = await fetch(`/api/chat/history/${sessionId}`);
                const data = await response.json();

                if (data.conversations && data.conversations.length > 0) {
                    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾©å…ƒ
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';

                    data.conversations.forEach(conv => {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                        if (conv.user_message) {
                            addMessage('user', conv.user_message, false, null, conv.created_at, conv.id);
                        }
                        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ ï¼ˆJSONå‡¦ç†ã‚’é©ç”¨ï¼‰
                        if (conv.agent_response) {
                            // å±¥æ­´å¾©å…ƒæ™‚ã‚‚JSONå‡¦ç†ã‚’é©ç”¨
                            const formattedResponse = formatAiResponse(conv.agent_response);
                            addMessage('assistant', formattedResponse, false, conv.trace_id, conv.created_at, conv.id);
                        }
                    });

                    return true;
                }
                return false;
            } catch (error) {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                return false;
            }
        }

        // é€šçŸ¥ã‚’è¡¨ç¤º
        function showNotification(message, type = 'info') {
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ä¾¡æ ¼æƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatPricing(pricing) {
            if (!pricing) {
                return '';
            }

            const { type, input_cost, output_cost, currency, unit, note } = pricing;

            if (type === 'free') {
                return `ğŸ’° ç„¡æ–™ ${note ? `(${note})` : ''}`;
            } else if (type === 'pay_per_use') {
                const inputCostStr = input_cost === 0 ? 'ç„¡æ–™' : `$${input_cost}`;
                const outputCostStr = output_cost === 0 ? 'ç„¡æ–™' : `$${output_cost}`;

                let priceText = `ğŸ’° å…¥åŠ›: ${inputCostStr} / å‡ºåŠ›: ${outputCostStr} per ${unit}`;
                if (note) {
                    priceText += ` (${note})`;
                }
                return priceText;
            } else {
                return note ? `ğŸ’° ${note}` : '';
            }
        }

        // LLMã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateLLMStatus() {
            const select = document.getElementById('llmSelect');
            const indicator = document.getElementById('llmIndicator');
            const status = document.getElementById('llmStatus');
            const pricing = document.getElementById('llmPricing');

            const selectedOption = select.options[select.selectedIndex];
            const provider = selectedOption.dataset.provider;
            const model = selectedOption.dataset.model;
            const color = selectedOption.dataset.color;
            const description = selectedOption.dataset.description;

            // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è‰²ã‚’æ›´æ–°
            indicator.className = 'llm-indicator';
            if (color === 'green') {
                indicator.classList.add('available');
            } else if (color === 'red') {
                indicator.classList.add('unavailable');
            } else {
                indicator.classList.add('loading');
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            status.textContent = `${provider} - ${model}`;
            if (description) {
                status.title = description;
            }

            // ä¾¡æ ¼æƒ…å ±ã‚’æ›´æ–°
            try {
                const llmConfigsData = JSON.parse(llmConfigs);
                const selectedModel = llmConfigsData.find(m => m.value === select.value);
                if (selectedModel && selectedModel.pricing) {
                    pricing.innerHTML = formatPricing(selectedModel.pricing);
                } else {
                    pricing.innerHTML = '';
                }
            } catch (error) {
                console.error('ä¾¡æ ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                pricing.innerHTML = '';
            }
        }

        // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
        async function handleApiResponse(data) {
            let conversationId = data.conversation_id;
            let displayContent = '';

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯ç‰¹åˆ¥ãªå½¢å¼ã§è¡¨ç¤º
            if (data.error_message) {
                displayContent = formatErrorMessage(data.error_message);
            } else if (data.response) {
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¦å‡¦ç†
                displayContent = formatAiResponse(data.response);
            } else {
                displayContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }

            return {
                content: displayContent,
                conversationId: conversationId,
                traceId: data.trace_id,
                hasError: !!data.error_message
            };
        }

        // AIå›ç­”ã®JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatAiResponse(response) {
            try {
                // JSONã‹ã©ã†ã‹ã‚’åˆ¤å®š
                let jsonData;
                if (typeof response === 'string') {
                    // æ–‡å­—åˆ—ã®å ´åˆã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
                    jsonData = JSON.parse(response);
                } else if (typeof response === 'object') {
                    // ã™ã§ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                    jsonData = response;
                } else {
                    // ãã®ä»–ã®å ´åˆã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†
                    return response;
                }

                // å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (jsonData && (jsonData.html_content !== undefined || jsonData.error !== undefined || jsonData.next_actions !== undefined)) {
                    return formatStructuredResponse(jsonData);
                } else {
                    // æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãªã„å ´åˆã¯å…ƒã®å½¢å¼ã§è¿”ã™
                    return response;
                }
            } catch (e) {
                // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†
                return response;
            }
        }

        // æ§‹é€ åŒ–ã•ã‚ŒãŸAIå›ç­”ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatStructuredResponse(jsonData) {
            let html = '<div class="ai-response-container">';

            // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®ã¿
            if (jsonData.error && jsonData.error.trim() !== '') {
                html += `
                    <div class="ai-error-display">
                        <span class="error-icon">âš ï¸</span>
                        <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${jsonData.error}
                    </div>
                `;
            }

            // html_contentã‚’è¡¨ç¤º
            if (jsonData.html_content && jsonData.html_content.trim() !== '') {
                html += `
                    <div class="ai-html-content">
                        ${jsonData.html_content}
                    </div>
                `;
            }

            // ãã®ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¤ºï¼ˆerrorã€html_contentã€next_actionsä»¥å¤–ï¼‰
            const handledProperties = ['error', 'html_content', 'next_actions'];
            const otherProperties = Object.keys(jsonData).filter(key => !handledProperties.includes(key));

            if (otherProperties.length > 0) {
                html += `
                    <div class="ai-other-properties">
                        <div class="ai-other-properties-content">
                `;

                otherProperties.forEach(key => {
                    const value = jsonData[key];
                    if (value !== null && value !== undefined && value !== '') {
                        html += `
                            <div class="ai-property-item">
                                <div class="ai-property-key">${key}:</div>
                                <div class="ai-property-value">${formatPropertyValue(value)}</div>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // next_actionsã‚’è¡¨ç¤º
            if (jsonData.next_actions) {
                // next_actionsãŒæ–‡å­—åˆ—ã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
                let actionsArray = [];
                if (typeof jsonData.next_actions === 'string' && jsonData.next_actions.trim() !== '') {
                    actionsArray = [jsonData.next_actions];
                } else if (Array.isArray(jsonData.next_actions) && jsonData.next_actions.length > 0) {
                    actionsArray = jsonData.next_actions;
                }

                if (actionsArray.length > 0) {
                    html += `
                        <div class="ai-next-actions">
                            <div class="ai-next-actions-title">
                                <span>ğŸ’¡</span>
                                æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                            </div>
                            <ul class="ai-next-actions-list">
                    `;

                    actionsArray.forEach((action, index) => {
                        if (action && action.trim() !== '') {
                            html += `<li class="ai-next-actions-item"><button class="ai-next-action-link" onclick="copyActionToInput('${action.replace(/'/g, "\\'")}')">${action}</button></li>`;
                        }
                    });

                    html += `
                            </ul>
                        </div>
                    `;
                }
            }

            html += '</div>';
            return html;
        }

        // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatPropertyValue(value) {
            if (typeof value === 'object') {
                if (Array.isArray(value)) {
                    // é…åˆ—ã®å ´åˆ
                    if (value.length === 0) return '[]';
                    return '<ul class="ai-property-array">' + 
                           value.map(item => `<li>${formatPropertyValue(item)}</li>`).join('') + 
                           '</ul>';
                } else {
                    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
                    if (Object.keys(value).length === 0) return '{}';
                    let objHtml = '<div class="ai-property-object">';
                    Object.keys(value).forEach(key => {
                        objHtml += `<div class="ai-property-object-item">
                                      <span class="ai-property-object-key">${key}:</span>
                                      <span class="ai-property-object-value">${formatPropertyValue(value[key])}</span>
                                    </div>`;
                    });
                    objHtml += '</div>';
                    return objHtml;
                }
            } else if (typeof value === 'string') {
                // æ–‡å­—åˆ—ã®å ´åˆã€æ”¹è¡Œã‚’<br>ã«å¤‰æ›
                return value.replace(/\n/g, '<br>');
            } else {
                // ãã®ä»–ã®å ´åˆï¼ˆæ•°å€¤ã€çœŸå½å€¤ãªã©ï¼‰
                return String(value);
            }
        }

        // next_actionã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›æ¬„ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
        function copyActionToInput(actionText) {
            const input = document.getElementById('commandInput');
            input.value = actionText;
            input.focus();

            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            autoResize(input);

            // é€šçŸ¥ã‚’è¡¨ç¤º
            showNotification('ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›æ¬„ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç‰¹åˆ¥ãªå½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatErrorMessage(errorMessage) {
            return `<div class="error-message-container">
                <div class="error-header">
                    <span class="error-icon">âš ï¸</span>
                    <span class="error-title">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>
                </div>
                <div class="error-content">
                    ${errorMessage.replace(/\n/g, '<br>')}
                </div>
                <div class="error-actions">
                    <button class="error-retry-btn" onclick="retryLastMessage()">å†è©¦è¡Œ</button>
                </div>
            </div>`;
        }

        // æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†è©¦è¡Œ
        function retryLastMessage() {
            const messages = document.querySelectorAll('.message.user');
            if (messages.length > 0) {
                const lastUserMessage = messages[messages.length - 1];
                const messageText = lastUserMessage.querySelector('.message-text');
                if (messageText) {
                    document.getElementById('commandInput').value = messageText.textContent;
                    sendMessage();
                }
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ä¿®æ­£ç‰ˆ
        async function sendMessage() {
            const input = document.getElementById('commandInput');
            const message = input.value.trim();

            if (!message) return;

            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ™‚çš„ã«è¡¨ç¤ºï¼ˆconversation IDã¯å¾Œã§æ›´æ–°ï¼‰
            const userMessageId = addMessage('user', message, false, null, new Date().toISOString());
            input.value = '';
            autoResize(input);

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingId = addMessage('assistant', '', true);

            try {
                // é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMã‚¿ã‚¤ãƒ—ã‚’å–å¾—
                const selectedAgent = document.getElementById('agentSelect').value;
                const llmModel = document.getElementById('llmSelect').value;

                // é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«åŸºã¥ã„ã¦APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ±ºå®š
                let apiUrl;
                if (selectedAgent === 'AgentDirector') {
                    apiUrl = '/api/agent/director-agent/chat';
                } else {
                    // ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å ´åˆã¯å˜ä¸€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆAPIã‚’ä½¿ç”¨
                    apiUrl = '/api/agent/single-agent/chat';
                }
                const requestBody = {
                    message: message,
                    user_id: currentUserId,
                    session_id: currentSessionId,
                    llm_type: llmModel,
                    agent_type: selectedAgent,
                    context: {}
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
                const processedResponse = await handleApiResponse(data);

                // conversation IDãŒå–å¾—ã§ããŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚‚è¨­å®š
                if (processedResponse.conversationId) {
                    const userMessageElement = document.getElementById(userMessageId);
                    if (userMessageElement) {
                        userMessageElement.setAttribute('data-conversation-id', processedResponse.conversationId);
                    }
                }

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                removeMessage(loadingId);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã«å¿œã˜ã¦å‡¦ç†ï¼‰
                addMessage('assistant', processedResponse.content, false, processedResponse.traceId, new Date().toISOString(), processedResponse.conversationId, processedResponse.hasError);

            } catch (error) {
                console.error('Error:', error);
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                removeMessage(loadingId);
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const errorContent = formatErrorMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                addMessage('assistant', errorContent, false, null, new Date().toISOString(), null, true);
            } finally {
                // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Execute scripts in dynamically inserted HTML content
        function executeScriptsInElement(element) {
            const scripts = element.querySelectorAll('script');
            scripts.forEach(script => {
                try {
                    // Create a new script element and copy attributes
                    const newScript = document.createElement('script');

                    // Copy all attributes from the original script
                    Array.from(script.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });

                    // Set the script content
                    if (script.src) {
                        // External script - set src
                        newScript.src = script.src;
                    } else {
                        // Inline script - set text content
                        newScript.textContent = script.textContent;
                    }

                    // Remove the original script and add the new one to execute it
                    script.parentNode.replaceChild(newScript, script);
                } catch (error) {
                    console.error('Error executing script:', error);
                }
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå¯¾å¿œç‰ˆï¼‰
        function addMessage(role, content, isLoading = false, traceId = null, timestamp = null, conversationId = null, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.id = messageId;

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            if (isError) {
                messageDiv.classList.add('error-message');
            }

            // conversation IDã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿å­˜
            if (conversationId) {
                messageDiv.setAttribute('data-conversation-id', conversationId);
            }

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isLoading) {
                contentDiv.innerHTML = '<div class="loading">å›ç­”ã‚’ç”Ÿæˆä¸­...</div>';
            } else {
                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
                let contentHTML = '';
                if (timestamp) {
                    contentHTML += `<div class="message-timestamp">${new Date(timestamp).toLocaleString('ja-JP')}</div>`;
                }

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤ºã€é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¤‰æ›
                let formattedContent;
                if (isError) {
                    formattedContent = content; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã™ã§ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿
                } else if (content.includes('ai-html-content') || content.includes('ai-response-container')) {
                    // HTML content (structured response) ã®å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤ºï¼ˆnewline to br conversion ã‚’é©ç”¨ã—ãªã„ï¼‰
                    formattedContent = content;
                } else {
                    formattedContent = content
                        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                        .replace(/`([^`]+)`/g, '<code>$1</code>')
                        .replace(/\n/g, '<br>');
                }

                contentHTML += `<div class="message-text">${formattedContent}</div>`;
                contentDiv.innerHTML = contentHTML;

                // Execute any scripts in the inserted HTML content
                executeScriptsInElement(contentDiv);

                // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯è¿½åŠ ã—ãªã„ï¼‰
                if (role === 'assistant' && !isLoading && !isError) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';

                    // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'action-btn copy';
                    copyBtn.innerHTML = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                    copyBtn.onclick = () => copyMessage(content);

                    // å†ç”Ÿæˆãƒœã‚¿ãƒ³
                    const regenerateBtn = document.createElement('button');
                    regenerateBtn.className = 'action-btn regenerate';
                    regenerateBtn.innerHTML = 'ğŸ”„ å†ç”Ÿæˆ';
                    regenerateBtn.onclick = () => regenerateMessage(messageId, conversationId);

                    // è‰¯ã„ãƒœã‚¿ãƒ³
                    const goodBtn = document.createElement('button');
                    goodBtn.className = 'action-btn good';
                    goodBtn.innerHTML = 'ğŸ‘ è‰¯ã„';
                    goodBtn.onclick = () => evaluateMessage(traceId, 'good', messageId);

                    // æ‚ªã„ãƒœã‚¿ãƒ³
                    const badBtn = document.createElement('button');
                    badBtn.className = 'action-btn bad';
                    badBtn.innerHTML = 'ğŸ‘ æ‚ªã„';
                    badBtn.onclick = () => evaluateMessage(traceId, 'bad', messageId);

                    actionsDiv.appendChild(copyBtn);
                    actionsDiv.appendChild(regenerateBtn);
                    actionsDiv.appendChild(goodBtn);
                    actionsDiv.appendChild(badBtn);

                    contentDiv.appendChild(actionsDiv);
                }
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return messageId;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        function removeMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.remove();
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼
        async function copyMessage(content) {
            try {
                // HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';

                await navigator.clipboard.writeText(plainText);
                showNotification('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†ç”Ÿæˆ
        async function regenerateMessage(messageId, conversationId) {
            try {
                if (!conversationId) {
                    showNotification('å†ç”Ÿæˆã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®conversation IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                // ç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’å–å¾—ã—ã¦ä½ç½®ã‚’è¨˜éŒ²
                const currentMessageElement = document.getElementById(messageId);
                if (!currentMessageElement) {
                    showNotification('å†ç”Ÿæˆã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                // å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆconversation IDã‚’ä½¿ç”¨ï¼‰
                const chatMessages = document.getElementById('chatMessages');
                const messages = chatMessages.querySelectorAll('.message');
                let targetUserMessage = '';
                let userMessageElement = null;

                // conversation IDã«å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™
                for (let i = 0; i < messages.length; i++) {
                    const messageElement = messages[i];
                    const msgConversationId = messageElement.getAttribute('data-conversation-id');

                    if (msgConversationId == conversationId && messageElement.classList.contains('user')) {
                        const contentDiv = messageElement.querySelector('.message-content .message-text');
                        targetUserMessage = contentDiv ? (contentDiv.textContent || contentDiv.innerText || '') : '';
                        userMessageElement = messageElement;
                        break;
                    }
                }

                if (!targetUserMessage) {
                    showNotification('å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                // ç¾åœ¨ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½ç½®ã‚’è¨˜éŒ²
                const nextSibling = currentMessageElement.nextSibling;
                const parentElement = currentMessageElement.parentElement;

                // ç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
                removeMessage(messageId);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’åŒã˜ä½ç½®ã«æŒ¿å…¥
                const loadingMessageDiv = document.createElement('div');
                loadingMessageDiv.className = 'message assistant';
                loadingMessageDiv.id = 'loading_' + Date.now();

                const loadingAvatar = document.createElement('div');
                loadingAvatar.className = 'message-avatar';
                loadingAvatar.textContent = 'ğŸ¤–';

                const loadingContentDiv = document.createElement('div');
                loadingContentDiv.className = 'message-content';
                loadingContentDiv.innerHTML = '<div class="loading">å›ç­”ã‚’å†ç”Ÿæˆä¸­...</div>';

                loadingMessageDiv.appendChild(loadingAvatar);
                loadingMessageDiv.appendChild(loadingContentDiv);

                // å…ƒã®ä½ç½®ã«æŒ¿å…¥
                if (nextSibling) {
                    parentElement.insertBefore(loadingMessageDiv, nextSibling);
                } else {
                    parentElement.appendChild(loadingMessageDiv);
                }

                // é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—
                const selectedAgent = document.getElementById('agentSelect').value;
                const llmModel = document.getElementById('llmSelect').value;

                const response = await fetch('/api/chat/regenerate_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        query: targetUserMessage,
                        session_id: currentSessionId,
                        user_id: currentUserId,
                        agent_type: selectedAgent,
                        llm_type: llmModel,
                        conversation_id: conversationId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ï¼ˆsendMessageã¨åŒã˜å‡¦ç†ã‚’é©ç”¨ï¼‰
                const processedResponse = await handleApiResponse(data);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                loadingMessageDiv.remove();

                // æ–°ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å…ƒã®ä½ç½®ã«è¡¨ç¤º
                const newMessageDiv = document.createElement('div');
                newMessageDiv.className = 'message assistant';
                newMessageDiv.id = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                // conversation IDã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿å­˜
                if (conversationId) {
                    newMessageDiv.setAttribute('data-conversation-id', conversationId);
                }

                const newAvatar = document.createElement('div');
                newAvatar.className = 'message-avatar';
                newAvatar.textContent = 'ğŸ¤–';

                const newContentDiv = document.createElement('div');
                newContentDiv.className = 'message-content';

                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
                let contentHTML = `<div class="message-timestamp">${new Date().toLocaleString('ja-JP')}</div>`;

                // å‡¦ç†æ¸ˆã¿ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½¿ç”¨
                let formattedContent = processedResponse.content || 'å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';

                contentHTML += `<div class="message-text">${formattedContent}</div>`;
                newContentDiv.innerHTML = contentHTML;

                // Execute any scripts in the inserted HTML content
                executeScriptsInElement(newContentDiv);

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';

                // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn copy';
                copyBtn.innerHTML = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                copyBtn.onclick = () => copyMessage(processedResponse.content || 'å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');

                // å†ç”Ÿæˆãƒœã‚¿ãƒ³
                const regenerateBtn = document.createElement('button');
                regenerateBtn.className = 'action-btn regenerate';
                regenerateBtn.innerHTML = 'ğŸ”„ å†ç”Ÿæˆ';
                regenerateBtn.onclick = () => regenerateMessage(newMessageDiv.id, conversationId);

                // è‰¯ã„ãƒœã‚¿ãƒ³
                const goodBtn = document.createElement('button');
                goodBtn.className = 'action-btn good';
                goodBtn.innerHTML = 'ğŸ‘ è‰¯ã„';
                goodBtn.onclick = () => evaluateMessage(data.trace_id, 'good', newMessageDiv.id);

                // æ‚ªã„ãƒœã‚¿ãƒ³
                const badBtn = document.createElement('button');
                badBtn.className = 'action-btn bad';
                badBtn.innerHTML = 'ğŸ‘ æ‚ªã„';
                badBtn.onclick = () => evaluateMessage(data.trace_id, 'bad', newMessageDiv.id);

                actionsDiv.appendChild(copyBtn);
                actionsDiv.appendChild(regenerateBtn);
                actionsDiv.appendChild(goodBtn);
                actionsDiv.appendChild(badBtn);

                newContentDiv.appendChild(actionsDiv);
                newMessageDiv.appendChild(newAvatar);
                newMessageDiv.appendChild(newContentDiv);

                // å…ƒã®ä½ç½®ã«æŒ¿å…¥
                if (nextSibling) {
                    parentElement.insertBefore(newMessageDiv, nextSibling);
                } else {
                    parentElement.appendChild(newMessageDiv);
                }

                showNotification('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸ', 'success');

            } catch (error) {
                console.error('å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showNotification('å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è©•ä¾¡
        async function evaluateMessage(traceId, evaluation, messageId) {
            if (!traceId) {
                showNotification('è©•ä¾¡ã§ãã¾ã›ã‚“ï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰', 'error');
                return;
            }

            try {
                const response = await fetch('/api/chat/evaluate_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        trace_id: traceId,
                        evaluation: evaluation,
                        user_id: currentUserId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                const messageElement = document.getElementById(messageId);
                if (messageElement) {
                    const actionBtns = messageElement.querySelectorAll('.action-btn.good, .action-btn.bad');
                    actionBtns.forEach(btn => {
                        btn.style.opacity = '0.5';
                        btn.disabled = true;
                    });

                    // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    const selectedBtn = messageElement.querySelector(`.action-btn.${evaluation}`);
                    if (selectedBtn) {
                        selectedBtn.style.opacity = '1';
                        selectedBtn.style.fontWeight = 'bold';
                    }
                }

                const evaluationText = evaluation === 'good' ? 'è‰¯ã„' : 'æ‚ªã„';
                showNotification(`è©•ä¾¡ã€Œ${evaluationText}ã€ã‚’é€ä¿¡ã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                console.error('è©•ä¾¡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showNotification('è©•ä¾¡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // å…¥åŠ›å‡¦ç†
        function handleInput(e) {
            autoResize(e.target);
        }

        // ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // Shift+Enter: æ”¹è¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼‰
                    return;
                } else {
                    // Enter: é€ä¿¡ï¼ˆIMEå…¥åŠ›ä¸­ã§ãªã„å ´åˆã‹ã¤é€ä¿¡ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
                    if (!isComposing) {
                        e.preventDefault();
                        // é€ä¿¡ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é€ä¿¡ã—ãªã„
                        const sendBtn = document.getElementById('sendBtn');
                        if (!sendBtn.disabled) {
                            sendMessage();
                        }
                    }
                }
            }
        }

        // IMEå…¥åŠ›é–‹å§‹
        function handleCompositionStart(e) {
            isComposing = true;
        }

        // IMEå…¥åŠ›æ›´æ–°
        function handleCompositionUpdate(e) {
            isComposing = true;
        }

        // IMEå…¥åŠ›çµ‚äº†
        function handleCompositionEnd(e) {
            isComposing = false;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('llmSelect').addEventListener('change', function() {
            updateLLMStatus();
            saveLLMSelection();
        });

        document.getElementById('agentSelect').addEventListener('change', saveAgentSelection);

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const commandInput = document.getElementById('commandInput');

        // åŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // å…¥åŠ›çŠ¶æ…‹ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã®è¿½åŠ inputã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        commandInput.addEventListener('input', handleInput);
        commandInput.addEventListener('keypress', handleKeyDown);

        // IMEã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆMacæœ€é©åŒ–ï¼‰
        commandInput.addEventListener('compositionstart', handleCompositionStart);
        commandInput.addEventListener('compositionupdate', handleCompositionUpdate);
        commandInput.addEventListener('compositionend', handleCompositionEnd);

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°
        commandInput.addEventListener('focus', function() {
            this.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
        });

        commandInput.addEventListener('blur', function() {
            this.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
        });

        // ESCã‚­ãƒ¼ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHistorySidebar();
            }
        });

        // åˆæœŸåŒ–
        restoreSelections();
        updateLLMStatus();

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        window.addEventListener('load', async function() {
            loadConversationHistory();

            // æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒã‚ã‚‹å ´åˆã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¼šè©±å±¥æ­´ã‚’è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿
            if (currentSessionId && currentSessionId !== '') {
                try {
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¼šè©±å±¥æ­´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const response = await fetch(`/api/chat/history/${currentSessionId}`);
                    const data = await response.json();

                    if (data.conversations && data.conversations.length > 0) {
                        // ä¼šè©±å±¥æ­´ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿
                        await loadSessionHistory(currentSessionId);
                        console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¼šè©±å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', currentSessionId);
                    }
                } catch (error) {
                    console.log('æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¼šè©±å±¥æ­´èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ:', error);
                }
            }

            commandInput.focus(); // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        });

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†
        window.addEventListener('resize', function() {
            autoResize(commandInput);
        });
    </script>
</body>
</html>
